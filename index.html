<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>K√Ω t√™n ƒëa n·ªÅn t·∫£ng</title>
    <style>
      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }
      .container {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        max-width: 600px;
        width: 100%;
      }
      h2 {
        margin: 0 0 20px 0;
        text-align: center;
        color: #333;
        font-size: 24px;
      }
      .signature-box {
        border: 3px solid #e0e0e0;
        border-radius: 12px;
        background: #fafafa;
        box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.05);
        width: 100%;
        height: 300px;
        position: relative;
        margin-bottom: 20px;
      }
      canvas {
        width: 100%;
        height: 100%;
        cursor: crosshair;
        border-radius: 12px;
        touch-action: none;
      }
      .controls {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .control-row {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }
      .control-group {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
        min-width: 150px;
      }
      .control-group label {
        font-size: 14px;
        color: #555;
        white-space: nowrap;
      }
      input[type="color"] {
        width: 50px;
        height: 36px;
        border: 2px solid #ddd;
        border-radius: 8px;
        cursor: pointer;
        background: white;
      }
      input[type="range"] {
        flex: 1;
        cursor: pointer;
        height: 6px;
        border-radius: 3px;
        background: #e0e0e0;
        outline: none;
        -webkit-appearance: none;
      }
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #667eea;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }
      input[type="range"]::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #667eea;
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }
      .button-group {
        display: flex;
        gap: 12px;
        justify-content: center;
      }
      button {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        color: white;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        flex: 1;
        max-width: 150px;
      }
      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }
      button:active {
        transform: translateY(0);
      }
      .clear-btn {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }
      .save-btn {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      }
      .device-info {
        text-align: center;
        font-size: 12px;
        color: #888;
        margin-top: 8px;
      }
      @media (max-width: 480px) {
        body {
          padding: 10px;
        }
        .container {
          padding: 16px;
        }
        h2 {
          font-size: 20px;
        }
        .signature-box {
          height: 250px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>‚úçÔ∏è K√Ω t√™n ƒëa n·ªÅn t·∫£ng</h2>
      <div class="signature-box">
        <canvas id="signature"></canvas>
      </div>
      <div class="controls">
        <div class="control-row">
          <div class="control-group">
            <label>M√†u b√∫t:</label>
            <input type="color" id="penColor" value="#000000" />
          </div>
          <div class="control-group">
            <label>ƒê·ªô d√†y:</label>
            <input type="range" id="penWidth" min="1" max="10" value="3" />
            <span id="widthValue">3</span>
          </div>
        </div>
        <div class="control-row">
          <div class="control-group">
            <label>ƒê·ªô m∆∞·ª£t:</label>
            <input type="range" id="smoothness" min="1" max="10" value="5" />
            <span id="smoothValue">5</span>
          </div>
        </div>
        <div class="button-group">
          <button class="clear-btn" id="clear">üóëÔ∏è X√≥a</button>
          <button class="save-btn" id="save">üíæ L∆∞u ·∫£nh</button>
        </div>
      </div>
      <div class="device-info" id="deviceInfo">ƒêang t·∫£i...</div>
    </div>

    <script>
      const canvas = document.getElementById("signature");
      const ctx = canvas.getContext("2d");
      const colorPicker = document.getElementById("penColor");
      const widthPicker = document.getElementById("penWidth");
      const smoothnessPicker = document.getElementById("smoothness");
      const widthValue = document.getElementById("widthValue");
      const smoothValue = document.getElementById("smoothValue");
      const deviceInfo = document.getElementById("deviceInfo");

      let isDrawing = false;
      let points = [];
      let deviceType = "unknown";

      // Ph√°t hi·ªán thi·∫øt b·ªã
      function detectDevice() {
        const ua = navigator.userAgent;
        if (/iPad/i.test(ua)) return "iPad";
        if (/iPhone/i.test(ua)) return "iPhone";
        if (/Android/i.test(ua)) return "Android";
        if (/Mac/i.test(ua)) return "Mac";
        if (/Windows/i.test(ua)) return "Windows";
        return "Desktop";
      }
      deviceType = detectDevice();
      deviceInfo.textContent = `Thi·∫øt b·ªã: ${deviceType} | H·ªó tr·ª£: Chu·ªôt, Touch, Apple Pencil`;

      // Resize canvas v·ªõi devicePixelRatio cao
      function resizeCanvas() {
        const ratio = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * ratio;
        canvas.height = rect.height * ratio;
        ctx.scale(ratio, ratio);
        ctx.lineCap = "round";
        ctx.lineJoin = "round";
        ctx.strokeStyle = colorPicker.value;
      }
      resizeCanvas();
      window.addEventListener("resize", resizeCanvas);

      // L·∫•y v·ªã tr√≠ ch√≠nh x√°c
      const getPos = (e) => {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.clientX || (e.touches && e.touches[0]?.clientX) || 0;
        const clientY = e.clientY || (e.touches && e.touches[0]?.clientY) || 0;
        return {
          x: clientX - rect.left,
          y: clientY - rect.top
        };
      };

      // T√≠nh to√°n pressure th√¥ng minh
      function calculatePressure(e) {
        if (e.pointerType === "pen") {
          // Apple Pencil ho·∫∑c stylus kh√°c
          const basePressure = e.pressure || 0.5;
          return Math.max(0.2, Math.min(1.2, basePressure * 1.8));
        } else if (e.pointerType === "touch") {
          // Ng√≥n tay - pressure trung b√¨nh
          return e.pressure ? e.pressure * 1.3 : 0.7;
        } else {
          // Chu·ªôt - pressure c·ªë ƒë·ªãnh
          return 0.8;
        }
      }

      // Thu·∫≠t to√°n v·∫Ω m∆∞·ª£t v·ªõi Catmull-Rom spline (kh√¥ng d√πng n·ªØa - ƒë√£ t√≠ch h·ª£p v√†o draw)
      function drawSmoothLine() {
        // H√†m n√†y gi·ªØ l·∫°i ƒë·ªÉ t∆∞∆°ng th√≠ch, nh∆∞ng kh√¥ng d√πng
        return;
      }

      const startDrawing = (e) => {
        e.preventDefault();
        isDrawing = true;
        points = [];
        const pos = getPos(e);
        const pressure = calculatePressure(e);
        const width = parseInt(widthPicker.value) * pressure;
        points.push({ ...pos, width });
        
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
      };

      // Thu·∫≠t to√°n v·∫Ω m∆∞·ª£t - v·∫Ω tr·ª±c ti·∫øp trong qu√° tr√¨nh draw
      const draw = (e) => {
        if (!isDrawing) return;
        e.preventDefault();
        
        const pos = getPos(e);
        const pressure = calculatePressure(e);
        const baseWidth = parseInt(widthPicker.value);
        const width = baseWidth * pressure;
        const smoothFactor = parseInt(smoothnessPicker.value) / 10;
        
        points.push({ ...pos, width });

        // V·∫Ω m∆∞·ª£t ngay trong qu√° tr√¨nh v·∫Ω
        if (points.length >= 2) {
          const p1 = points[points.length - 2];
          const p2 = points[points.length - 1];
          
          ctx.lineWidth = (p1.width + p2.width) / 2;
          ctx.strokeStyle = colorPicker.value;
          
          if (points.length >= 3 && smoothFactor > 0.3) {
            // V·∫Ω ƒë∆∞·ªùng cong m∆∞·ª£t v·ªõi 3 ƒëi·ªÉm
            const p0 = points[points.length - 3];
            const cp1x = p1.x + (p2.x - p0.x) * smoothFactor * 0.25;
            const cp1y = p1.y + (p2.y - p0.y) * smoothFactor * 0.25;
            
            ctx.beginPath();
            ctx.moveTo(p1.x, p1.y);
            ctx.quadraticCurveTo(cp1x, cp1y, p2.x, p2.y);
            ctx.stroke();
          } else {
            // V·∫Ω ƒë∆∞·ªùng th·∫≥ng
            ctx.beginPath();
            ctx.moveTo(p1.x, p1.y);
            ctx.lineTo(p2.x, p2.y);
            ctx.stroke();
          }
        }
      };

      const stopDrawing = (e) => {
        if (!isDrawing) return;
        e.preventDefault();
        isDrawing = false;
        points = [];
      };

      // Event listeners cho t·∫•t c·∫£ thi·∫øt b·ªã
      canvas.addEventListener("pointerdown", startDrawing);
      canvas.addEventListener("pointermove", draw);
      canvas.addEventListener("pointerup", stopDrawing);
      canvas.addEventListener("pointerleave", stopDrawing);
      canvas.addEventListener("pointercancel", stopDrawing);

      // NgƒÉn scroll/zoom tr√™n mobile
      canvas.addEventListener("touchstart", (e) => e.preventDefault(), { passive: false });
      canvas.addEventListener("touchmove", (e) => e.preventDefault(), { passive: false });
      canvas.addEventListener("touchend", (e) => e.preventDefault(), { passive: false });

      // C·∫≠p nh·∫≠t m√†u
      colorPicker.addEventListener("change", (e) => {
        ctx.strokeStyle = e.target.value;
      });

      // C·∫≠p nh·∫≠t gi√° tr·ªã hi·ªÉn th·ªã
      widthPicker.addEventListener("input", (e) => {
        widthValue.textContent = e.target.value;
      });
      smoothnessPicker.addEventListener("input", (e) => {
        smoothValue.textContent = e.target.value;
      });

      // X√≥a canvas
      document.getElementById("clear").addEventListener("click", () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      });

      // L∆∞u ·∫£nh
      document.getElementById("save").addEventListener("click", () => {
        // T·∫°o canvas m·ªõi v·ªõi n·ªÅn tr·∫Øng
        const exportCanvas = document.createElement('canvas');
        exportCanvas.width = canvas.width;
        exportCanvas.height = canvas.height;
        const exportCtx = exportCanvas.getContext('2d');
        
        // V·∫Ω n·ªÅn tr·∫Øng
        exportCtx.fillStyle = '#ffffff';
        exportCtx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);
        
        // V·∫Ω ch·ªØ k√Ω l√™n tr√™n
        exportCtx.drawImage(canvas, 0, 0);
        
        const dataUrl = exportCanvas.toDataURL("image/png");
        const link = document.createElement("a");
        link.href = dataUrl;
        link.download = `signature_${Date.now()}.png`;
        link.click();
      });
    </script>
  </body>
</html>
